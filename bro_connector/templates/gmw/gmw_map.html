{% extends "admin/base_site.html" %} {% block content %} {% load static %}

<link rel="stylesheet" href="{% static 'polls/style.css' %}" />

<div id="deck-gl-canvas" style="height: 800px; width: 1000px">
  <div
    id="legend"
    style="
      position: absolute;
      right: 0;
      bottom: 20px;
      z-index: 100;
      background-color: white;
      padding: 1em;
    "
  ></div>
</div>
{{ wells|json_script:"wells_json" }}
<style>
  .mapboxgl-canvas.grab {
    cursor: grab !important;
  }

  .mapboxgl-canvas.pointer {
    cursor: pointer !important;
  }

  .mapboxgl-canvas.grabbing {
    cursor: grabbing !important;
  }
</style>
<link href="static/gmw/gmw_map.css" rel="stylesheet" />
<link
  href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css"
  rel="stylesheet"
/>

<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>

<script>
  const legend = document.getElementById("legend");

  const getRandomColor = () => {
    const randomRGB = (min = 0, max = 255) =>
      min + Math.floor(Math.random() * (max - min + 1));
    return [randomRGB(), randomRGB(), randomRGB()];
  };

  const colorMapping = {};
  const getMarkerColor = (accountablePartyId) => {
    if (!colorMapping.hasOwnProperty(accountablePartyId)) {
      // If color not assigned, generate and assign a new color
      colorMapping[accountablePartyId] = getRandomColor();
      // Append new color to legend
      const div = document.createElement("div");
      div.innerHTML +=
        '<div class="legend-item"><div class="legend-color" style="background:' +
        colorMapping[accountablePartyId] +
        ';"></div> Accountable Party ' +
        accountablePartyId +
        "</div>";
      legend.appendChild(div);
    }
    return colorMapping[accountablePartyId];
  };

  const createPopup = (well) => {
    const popup = document.createElement("div");
    popup.classList.add("popup");

    const objectPageUrl = `/admin/gmw/groundwatermonitoringwellstatic/${well.object_id}`;
    // Create a popup with well information and a link to the object page
    const popupContent = `
      <div style="background-color: white; padding: 1em; border-radius: 10px">
        <a href="${objectPageUrl}" target="_blank"><strong>${well.bro_id}</strong></a><br>
        Latitude: ${well.latitude}<br>
        Longitude: ${well.longitude}<br>
        Quality regime: ${well.quality_regime}<br>
        Accountable party: ${well.accountable_party}<br>
      </div>
      <div style="display: flex; width: 100%; justify-content: center; padding-bottom: 0.5em;">
        <div style="clip-path: polygon(100% 0, 0 0, 50% 100%); width: 10px; height: 10px; background-color: white;"></div>
      </div>
          `;
    popup.innerHTML = popupContent;
    return popup;
  };

  const wells = JSON.parse(document.getElementById("wells_json").textContent);
  const white = [255, 255, 255];
  let marker = null;

  // For each well, add a marker
  const myScatterplotLayer = new deck.MapboxLayer({
    id: "scatterplot-layer",
    data: wells,
    type: deck.ScatterplotLayer,
    getPosition: (well) => [well.longitude, well.latitude],
    pickable: true,
    radiusMaxPixels: 6.5,
    radiusUnits: "meters",
    getRadius: 10,
    lineWidthMaxPixels: 1,
    lineWidthUnits: "meters",
    getLineWidth: 0.005,
    stroked: true,
    filled: true,
    antialiasing: true,
    radiusUnits: "pixels",
    getFillColor: (well) => getMarkerColor(well.accountable_party),
    lineWidthMinPixels: 2,
    getLineColor: white,

    onClick: (event) => {
      const well = event.object;
      const popup = createPopup(well);
      const newMarker = new mapboxgl.Marker(popup, { anchor: "bottom" })
        .setLngLat([well.longitude, well.latitude])
        .addTo(map);
      setTimeout(() => (marker = newMarker));
    },
  });

  const map = new mapboxgl.Map({
    container: "deck-gl-canvas",
    style:
      "https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json",
    antialias: true,
    center: [3.945697, 51.522601],
    zoom: 9,
    bearing: 0,
    pitch: 0,
  });

  map.addControl(new mapboxgl.NavigationControl(), "top-left");

  map.on("load", () => map.addLayer(myScatterplotLayer));
  map.on("click", () => marker && marker.remove());

  const mapCanvas = map.getCanvas();
  let cursor = "pointer";
  const setCursorStyle = (style) => {
    cursor = style;
    mapCanvas.classList.remove("grab");
    mapCanvas.classList.remove("pointer");
    mapCanvas.classList.remove("grabbing");
    mapCanvas.classList.add(cursor);
  };

  map.on("dragstart", (e) => setCursorStyle("grabbing"));
  map.on("dragend", (e) => setCursorStyle("grab"));
  map.on("mousemove", (e) => {
    const isHovering =
      e.target.__deck && e.target.__deck.cursorState.isHovering;
    if (isHovering && cursor === "grab") return setCursorStyle("pointer");
    if (!isHovering && cursor === "pointer") return setCursorStyle("grab");
  });
</script>

{% endblock %}
